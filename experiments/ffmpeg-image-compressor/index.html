<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FFmpeg.wasm Image Compressor Test</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 { color: #00d4ff; }
        .drop-zone {
            border: 2px dashed #00d4ff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: background 0.2s;
        }
        .drop-zone:hover, .drop-zone.dragover {
            background: rgba(0, 212, 255, 0.1);
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        select, button {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            font-size: 16px;
        }
        button {
            background: #00d4ff;
            color: #1a1a2e;
            cursor: pointer;
            font-weight: bold;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        select {
            background: #333;
            color: #fff;
        }
        .results {
            margin: 20px 0;
            padding: 20px;
            background: #16213e;
            border-radius: 8px;
        }
        .preview {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .preview img {
            max-width: 300px;
            max-height: 300px;
            border-radius: 4px;
        }
        .preview-box {
            text-align: center;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.loading { background: #2d4a7c; }
        .status.success { background: #1a5c3a; }
        .status.error { background: #5c1a1a; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .stat {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .stat-value { font-size: 24px; font-weight: bold; color: #00d4ff; }
        .stat-label { font-size: 12px; color: #888; }
        pre {
            background: #0a0a14;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>FFmpeg.wasm Image Compressor</h1>
    <p>Test harness for WASM-based image compression. All processing happens locally in your browser.</p>

    <div class="drop-zone" id="dropZone">
        <p>Drop an image here or click to select</p>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
    </div>

    <div class="controls">
        <select id="formatSelect">
            <option value="webp">WebP (Best compression)</option>
            <option value="avif">AVIF (Best quality/size)</option>
            <option value="jpg">JPEG (Universal)</option>
            <option value="png">PNG (Lossless)</option>
        </select>
        <select id="qualitySelect">
            <option value="90">Quality: 90 (High)</option>
            <option value="80" selected>Quality: 80 (Recommended)</option>
            <option value="70">Quality: 70 (Medium)</option>
            <option value="50">Quality: 50 (Low)</option>
        </select>
        <button id="convertBtn" disabled>Convert Image</button>
        <button id="downloadBtn" disabled>Download Result</button>
    </div>

    <div id="status" class="status" style="display: none;"></div>

    <div id="results" class="results" style="display: none;">
        <h3>Results</h3>
        <div class="stats" id="stats"></div>
        <div class="preview" id="preview"></div>
        <h4>FFmpeg Command</h4>
        <pre id="command"></pre>
    </div>

    <script type="module">
        import { FFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.15/dist/esm/index.js';
        import { fetchFile, toBlobURL } from 'https://unpkg.com/@ffmpeg/util@0.12.2/dist/esm/index.js';

        const ffmpeg = new FFmpeg();
        let inputFile = null;
        let outputBlob = null;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const formatSelect = document.getElementById('formatSelect');
        const qualitySelect = document.getElementById('qualitySelect');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('results');
        const statsEl = document.getElementById('stats');
        const previewEl = document.getElementById('preview');
        const commandEl = document.getElementById('command');

        // Status helper
        function showStatus(message, type = 'loading') {
            statusEl.style.display = 'block';
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        // Initialize FFmpeg
        async function initFFmpeg() {
            showStatus('Loading FFmpeg.wasm (~30MB)...');

            const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.10/dist/esm';

            ffmpeg.on('log', ({ message }) => {
                console.log('[FFmpeg]', message);
            });

            ffmpeg.on('progress', ({ progress }) => {
                showStatus(`Processing: ${Math.round(progress * 100)}%`);
            });

            try {
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });
                showStatus('FFmpeg ready! Drop an image to begin.', 'success');
                console.log('FFmpeg loaded successfully');
            } catch (error) {
                showStatus(`Failed to load FFmpeg: ${error.message}`, 'error');
                console.error('FFmpeg load error:', error);
            }
        }

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showStatus('Please select an image file', 'error');
                return;
            }
            inputFile = file;
            dropZone.innerHTML = `<p>Selected: ${file.name} (${formatSize(file.size)})</p>`;
            convertBtn.disabled = false;
            downloadBtn.disabled = true;
            resultsEl.style.display = 'none';
            showStatus('Image loaded. Click Convert to process.', 'success');
        }

        // Conversion
        convertBtn.addEventListener('click', async () => {
            if (!inputFile) return;

            const format = formatSelect.value;
            const quality = qualitySelect.value;
            const startTime = performance.now();

            try {
                convertBtn.disabled = true;
                showStatus('Reading input file...');

                const inputName = 'input' + getExtension(inputFile.name);
                const outputName = `output.${format}`;

                // Write input file to FFmpeg filesystem
                await ffmpeg.writeFile(inputName, await fetchFile(inputFile));

                // Build FFmpeg command
                let args = ['-i', inputName];

                if (format === 'webp') {
                    args.push('-c:v', 'libwebp', '-quality', quality);
                } else if (format === 'avif') {
                    args.push('-c:v', 'libaom-av1', '-crf', String(100 - parseInt(quality)), '-still-picture', '1');
                } else if (format === 'jpg') {
                    args.push('-q:v', String(Math.floor(31 - (parseInt(quality) / 100 * 31))));
                }
                // PNG is lossless, no quality setting needed

                args.push(outputName);

                showStatus('Converting...');
                const cmdString = `ffmpeg ${args.join(' ')}`;
                console.log('Running:', cmdString);

                await ffmpeg.exec(args);

                // Read output
                const data = await ffmpeg.readFile(outputName);
                outputBlob = new Blob([data], { type: `image/${format}` });

                const endTime = performance.now();
                const duration = (endTime - startTime) / 1000;

                // Cleanup
                await ffmpeg.deleteFile(inputName);
                await ffmpeg.deleteFile(outputName);

                // Show results
                displayResults(inputFile, outputBlob, format, quality, duration, cmdString);

                showStatus('Conversion complete!', 'success');
                downloadBtn.disabled = false;

            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
                console.error('Conversion error:', error);
            } finally {
                convertBtn.disabled = false;
            }
        });

        // Download
        downloadBtn.addEventListener('click', () => {
            if (!outputBlob) return;
            const url = URL.createObjectURL(outputBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compressed.${formatSelect.value}`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // Display results
        function displayResults(input, output, format, quality, duration, command) {
            resultsEl.style.display = 'block';

            const inputSize = input.size;
            const outputSize = output.size;
            const savings = ((1 - outputSize / inputSize) * 100).toFixed(1);

            statsEl.innerHTML = `
                <div class="stat">
                    <div class="stat-value">${formatSize(inputSize)}</div>
                    <div class="stat-label">Original Size</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${formatSize(outputSize)}</div>
                    <div class="stat-label">Compressed Size</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${savings}%</div>
                    <div class="stat-label">Size Reduction</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${duration.toFixed(2)}s</div>
                    <div class="stat-label">Processing Time</div>
                </div>
            `;

            const inputUrl = URL.createObjectURL(input);
            const outputUrl = URL.createObjectURL(output);

            previewEl.innerHTML = `
                <div class="preview-box">
                    <img src="${inputUrl}" alt="Original">
                    <p>Original (${input.type})</p>
                </div>
                <div class="preview-box">
                    <img src="${outputUrl}" alt="Compressed">
                    <p>Compressed (${format.toUpperCase()})</p>
                </div>
            `;

            commandEl.textContent = command;
        }

        // Helpers
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function getExtension(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return '.' + ext;
        }

        // Initialize
        initFFmpeg();
    </script>
</body>
</html>
